<!DOCTYPE html>
<html>
<head>
  <title>Factory.coffee</title>
  <meta http-equiv="content-type" content="text/html; charset=UTF-8">
  <link rel="stylesheet" media="all" href="../doc-style.css" />
  <script src="../doc-filelist.js"></script>
  <script>
    var relativeDir = "../", thisFile = "src/Factory.coffee", defaultSidebar = true;
  </script>
  <script src="../doc-script.js"></script>
  <link rel="stylesheet" href="../docker.css" />
</head>
<body>
  <div id="sidebar_wrapper">
    <div id="sidebar_switch">
      <span class="tree">Files</span>
      <span class="headings">Headings</span>
    </div>
    <div id="tree"></div>
    <div id="headings">
      <div class="heading h2">
        <a href="#factory%20for%20object%20management">Factory for object management</a>
      </div>
      <div class="heading h2">
        <a href="#enhance%20object">Enhance Object</a>
      </div>
      <div class="heading h2">
        <a href="#compose%20config">Compose Config</a>
      </div>
      <div class="heading h2">
        <a href="#constructor">Constructor</a>
      </div>
      <div class="heading h2">
        <a href="#define">Define</a>
      </div>
      <div class="heading h2">
        <a href="#extend">Extend</a>
      </div>
      <div class="heading h2">
        <a href="#has%20definition">Has Definition</a>
      </div>
      <div class="heading h2">
        <a href="#get%20definition">Get Definition</a>
      </div>
      <div class="heading h2">
        <a href="#fetch%20definition">Fetch Definition</a>
      </div>
      <div class="heading h2">
        <a href="#when%20defined">When Defined</a>
      </div>
      <div class="heading h2">
        <a href="#get%20constructor">Get Constructor</a>
      </div>
      <div class="heading h2">
        <a href="#get">Get</a>
      </div>
      <div class="heading h2">
        <a href="#get%20instance">Get Instance</a>
      </div>
      <div class="heading h2">
        <a href="#resolve%20instance">Resolve Instance</a>
      </div>
      <div class="heading h2">
        <a href="#mixins">Mixins</a>
      </div>
    </div>
  </div>
  <div id="sidebar-toggle"></div>
  <div id="container"><div class="background highlight"></div>
<table cellpadding="0" cellspacing="0">
  <tbody>
      <tr>
        <td class="docs">
<div class="pilwrap" id="factory%20for%20object%20management">
  <h2>
    <a href="#factory%20for%20object%20management" name="factory%20for%20object%20management" class="pilcrow">&#182;</a>
    Factory for object management
  </h2>
</div>


<p>Use require, this depends on underscore, jquery and backbone.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre><span class="nx">define</span> <span class="p">[</span>
  <span class="s">&quot;underscore&quot;</span><span class="p">,</span>
  <span class="s">&quot;jquery&quot;</span><span class="p">,</span>
  <span class="s">&quot;backbone&quot;</span>
<span class="p">],</span> <span class="nf">(_, $, Backbone) -&gt;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-2" id="section-2">&#182;</a>
</div>
<p>Factory objects can
 * Define constructors.
 * Extend existing constructors.
 * Create instances of a constructor.
 * Dispose instance references.
 * Resolve singletons instances.
 * Define mixins.
 * Compose mixins onto an instance.
 * Tag instances with types and other metadata.
 * Retrieve and manipulate instances by tag.
 * Inject instances into other instances.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="enhance%20object">
  <h2>
    <a href="#enhance%20object" name="enhance%20object" class="pilcrow">&#182;</a>
    Enhance Object
  </h2>
</div>


<p>Ensures that an object has the correct factory interface</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
  <span class="nv">_enhanceObject = </span><span class="nf">(factory, name, definition, object) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-4" id="section-4">&#182;</a>
</div>
<p>Object environment interfaces</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">object.__type = </span><span class="nf">-&gt;</span> <span class="nx">name</span>
    <span class="nv">object.__factory = </span><span class="nf">-&gt;</span> <span class="nx">factory</span>
    <span class="nv">object.__activeMixins = </span><span class="nf">-&gt;</span> <span class="p">[]</span>

    <span class="nv">object.__tags = </span><span class="nf">-&gt;</span>
      <span class="k">return</span> <span class="nx">factory</span><span class="p">.</span><span class="nx">getTags</span> <span class="nx">object</span>

    <span class="nv">object.__mixins = </span><span class="nf">-&gt;</span>
      <span class="k">return</span> <span class="nx">factory</span><span class="p">.</span><span class="nx">composeMixinDependencies</span> <span class="nx">definition</span><span class="p">.</span><span class="nx">options</span><span class="o">?</span><span class="p">.</span><span class="nx">mixins</span>

    <span class="nv">object.__singleton = </span><span class="nf">-&gt;</span>
      <span class="k">return</span> <span class="nb">Boolean</span> <span class="nx">definition</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">singleton</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-5" id="section-5">&#182;</a>
</div>
<p>Factory method interfaces</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nv">object.__mixin = </span><span class="nf">-&gt;</span> <span class="nx">factory</span><span class="p">.</span><span class="nx">applyMixin</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span>
    <span class="nv">object.__dispose = </span><span class="nf">-&gt;</span> <span class="nx">factory</span><span class="p">.</span><span class="nx">disposeInstance</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="compose%20config">
  <h2>
    <a href="#compose%20config" name="compose%20config" class="pilcrow">&#182;</a>
    Compose Config
  </h2>
</div>


<p>composeConfig allows mixed object/function combinations to be
resolvable to configuration objects/arrays, etc.
Arrays are concatenated, objects are extended.
Constructor configurations are the responsibility of mixins.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

  <span class="nv">_composeConfig = </span><span class="nf">(defaultConfig, overrideConfig, args...) -&gt;</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">defaultConfig</span>
      <span class="nv">defaultConfig = </span><span class="nx">defaultConfig</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span>
    <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">overrideConfig</span>
      <span class="nv">overrideConfig = </span><span class="nx">overrideConfig</span><span class="p">.</span><span class="nx">apply</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span><span class="p">(</span><span class="nx">defaultConfig</span><span class="p">)</span> <span class="k">unless</span> <span class="nx">overrideConfig</span><span class="o">?</span>
    <span class="k">return</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">defaultConfig</span><span class="p">)</span> <span class="o">and</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isArray</span><span class="p">(</span><span class="nx">overrideConfig</span><span class="p">)</span>
    <span class="k">then</span> <span class="p">[].</span><span class="nx">concat</span> <span class="nx">defaultConfig</span><span class="p">,</span> <span class="nx">overrideConfig</span>
    <span class="k">else</span> <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="p">{},</span> <span class="nx">defaultConfig</span><span class="p">,</span> <span class="nx">overrideConfig</span>

  <span class="nv">composeConfig = </span><span class="nf">(defaults, overrides...) -&gt;</span>
    <span class="k">return</span> <span class="nx">_</span><span class="p">.</span><span class="nx">reduce</span> <span class="nx">overrides</span><span class="p">,</span> <span class="p">(</span><span class="nf">(defaults, override) -&gt;</span>
      <span class="k">return</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">defaults</span><span class="p">)</span> <span class="o">or</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">override</span><span class="p">)</span>
      <span class="k">then</span> <span class="nf">-&gt;</span> <span class="nx">_composeConfig</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nx">defaults</span><span class="p">,</span> <span class="nx">override</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span>
      <span class="k">else</span> <span class="nx">_composeConfig</span> <span class="nx">defaults</span><span class="p">,</span> <span class="nx">override</span>
    <span class="p">),</span> <span class="nx">defaults</span>

  <span class="nv">extendMixinOptions = </span><span class="nf">(mixinOptions = {}, mixinDefaults = {}) -&gt;</span>
    <span class="k">for</span> <span class="nx">option</span><span class="p">,</span> <span class="nx">defaultValue</span> <span class="k">of</span> <span class="nx">mixinDefaults</span>
      <span class="nv">value = </span><span class="nx">mixinOptions</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">defaultValue</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-7" id="section-7">&#182;</a>
</div>
<p>Override the default value if one of the values is not extendable.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">and</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span><span class="p">(</span><span class="nx">defaultValue</span><span class="p">)</span>
        <span class="nx">mixinOptions</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">=</span> <span class="nx">value</span>
        <span class="k">continue</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-8" id="section-8">&#182;</a>
</div>
<p>Don't do anything if either object is an object type we don't support.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">continue</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isDate</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">or</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isDate</span><span class="p">(</span><span class="nx">defaultValue</span><span class="p">)</span> <span class="o">or</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">or</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isElement</span><span class="p">(</span><span class="nx">defaultValue</span><span class="p">)</span> <span class="o">or</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">or</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">defaultValue</span><span class="p">)</span> <span class="o">or</span>
      <span class="nx">_</span><span class="p">.</span><span class="nx">isRegExp</span><span class="p">(</span><span class="nx">value</span><span class="p">)</span> <span class="o">or</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isRegExp</span><span class="p">(</span><span class="nx">defaultValue</span><span class="p">)</span>

      <span class="nx">mixinOptions</span><span class="p">[</span><span class="nx">option</span><span class="p">]</span> <span class="o">=</span> <span class="nx">composeConfig</span> <span class="nx">defaultValue</span><span class="p">,</span> <span class="nx">value</span>

  <span class="k">class</span> <span class="nx">Factory</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Events</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-9" id="section-9">&#182;</a>
</div>
<p>Expose extendMixinOptions and composeConfig as both
class and instance methods</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="vi">@composeConfig: </span><span class="nx">composeConfig</span>
    <span class="vi">@extendMixinOptions: </span><span class="nx">extendMixinOptions</span>
    <span class="nx">_</span><span class="p">.</span><span class="nx">extend</span> <span class="nx">@prototype</span><span class="p">,</span> <span class="p">{</span><span class="nx">composeConfig</span><span class="p">,</span> <span class="nx">extendMixinOptions</span><span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="constructor_NaN">
  <h2>
    <a href="#constructor_NaN" name="constructor_NaN" class="pilcrow">&#182;</a>
    Constructor
  </h2>
</div>


<p>It only takes one argument, the base class implementation
to use as a default. It becomes the 'Base' type, you can extend.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nv">constructor: </span><span class="nf">(Base, options = {}) -&gt;</span>
      <span class="vi">@mixins = </span><span class="p">{}</span>
      <span class="vi">@tagMap = </span><span class="p">{}</span>
      <span class="vi">@promises = </span><span class="p">{}</span>
      <span class="vi">@instances = </span><span class="p">{}</span>
      <span class="vi">@mirrors = </span><span class="p">[]</span>
      <span class="vi">@definitions = </span><span class="p">{}</span>
      <span class="vi">@tagCallbacks = </span><span class="p">{}</span>
      <span class="vi">@baseTags = </span><span class="nx">options</span><span class="p">.</span><span class="nx">baseTags</span> <span class="o">or</span> <span class="p">[]</span>
      <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@handleCreate</span> <span class="nx">arguments</span><span class="p">...</span>
      <span class="nx">@</span><span class="kc">on</span> <span class="s">&#39;define&#39;</span><span class="p">,</span> <span class="o">=&gt;</span> <span class="nx">@handleDefine</span> <span class="nx">arguments</span><span class="p">...</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-11" id="section-11">&#182;</a>
</div>
<p>@on 'dispose', => @handleDispose arguments...</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@define</span> <span class="s">&#39;Base&#39;</span><span class="p">,</span> <span class="nx">Base</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="define">
  <h2>
    <a href="#define" name="define" class="pilcrow">&#182;</a>
    Define
  </h2>
</div>


<p>Use the define method to define a new type (constructor)
in the factory.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nv">define: </span><span class="nf">(name, definition, options = {}) -&gt;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">existingDefinition = </span><span class="nx">@getDefinition</span><span class="p">(</span><span class="nx">name</span><span class="p">))</span><span class="o">?</span> <span class="o">and</span> <span class="o">not</span> <span class="nx">options</span><span class="p">.</span><span class="nx">override</span>
        <span class="k">return</span> <span class="k">this</span> <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">silent</span>
        <span class="p">{</span><span class="nx">factory</span><span class="p">}</span> <span class="o">=</span> <span class="nx">existingDefinition</span>
        <span class="k">throw</span> <span class="k">new</span> <span class="nb">Error</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">          Factory</span><span class="err">#</span><span class="s">define Definition &quot;</span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s">&quot; already exists.</span>
<span class="s">          Definition exists in factory tagged with </span><span class="si">#{</span><span class="nx">factory</span><span class="p">.</span><span class="nx">baseTags</span><span class="si">}</span><span class="s">.</span>
<span class="s">          Use `override` to replace this definition in the current factory.</span>
<span class="s">        &quot;&quot;&quot;</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-13" id="section-13">&#182;</a>
</div>
<p>Have whenDefined create a new promise for this definition</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@whenDefined</span> <span class="nx">name</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-14" id="section-14">&#182;</a>
</div>
<p>Create the new definition.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">factoryDefinition = </span><span class="p">{</span> <span class="nx">options</span> <span class="p">}</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-15" id="section-15">&#182;</a>
</div>
<p>Store an object instead of a function if necessary.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span><span class="p">(</span><span class="nx">definition</span><span class="p">)</span>
      <span class="k">then</span> <span class="nv">factoryDefinition.constructor = </span><span class="nx">definition</span>
      <span class="k">else</span> <span class="nv">factoryDefinition.constructor = </span><span class="nf">-&gt;</span> <span class="nx">_</span><span class="p">.</span><span class="nx">clone</span> <span class="nx">definition</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-16" id="section-16">&#182;</a>
</div>
<p>Compose all the tags for this definition.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">factoryDefinition.tags = </span><span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">([</span><span class="nx">name</span><span class="p">])</span>
        <span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">tags</span><span class="p">).</span><span class="nx">union</span><span class="p">(</span><span class="nx">@baseTags</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">compact</span><span class="p">().</span><span class="nx">uniq</span><span class="p">().</span><span class="nx">value</span><span class="p">()</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-17" id="section-17">&#182;</a>
</div>
<p>Push this definition into our definitions array.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@definitions</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">=</span> <span class="nx">factoryDefinition</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-18" id="section-18">&#182;</a>
</div>
<p>If you need to know when a type is defined you can listen to
the define event on the factory or ask using whenDefined.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@trigger</span> <span class="s">&#39;define&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">factoryDefinition</span><span class="p">,</span> <span class="nx">options</span><span class="p">,</span> <span class="k">this</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-19" id="section-19">&#182;</a>
</div>
<p>Return the factory for chaining.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">return</span> <span class="k">this</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="extend">
  <h2>
    <a href="#extend" name="extend" class="pilcrow">&#182;</a>
    Extend
  </h2>
</div>


<p>Use extend to create a new definition that extends another in the factory.
It uses the default extend method (Backbone.Model.extend) on the
constructor unless a custom implementation was provided.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nv">extend: </span><span class="nf">(base, name, definition, options = {}) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-21" id="section-21">&#182;</a>
</div>
<p>Attempt to resolve the base defintion from this, or upstream mirrors.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="p">{</span><span class="nx">definition</span><span class="o">:</span><span class="nx">baseDefinition</span><span class="p">,</span><span class="nx">factory</span><span class="o">:</span><span class="nx">baseFactory</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@_getDefinitionSpec</span> <span class="nx">base</span>

      <span class="k">throw</span> <span class="k">new</span> <span class="nx">TypeError</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        Factory</span><span class="err">#</span><span class="s">extend Invalid Argument.</span>
<span class="s">        `definition` must be an Object.</span>
<span class="s">      &quot;&quot;&quot;</span> <span class="k">unless</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isObject</span> <span class="nx">definition</span>

      <span class="nv">options.tags = </span><span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">([])</span>
        <span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">baseDefinition</span><span class="p">.</span><span class="nx">tags</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">baseFactory</span><span class="p">.</span><span class="nx">baseTags</span><span class="p">)</span>
        <span class="p">.</span><span class="nx">compact</span><span class="p">().</span><span class="nx">uniq</span><span class="p">().</span><span class="nx">value</span><span class="p">()</span>

      <span class="k">if</span> <span class="nx">options</span><span class="p">.</span><span class="nx">inheritMixins</span>
        <span class="nv">options.mixins = </span><span class="nx">_</span><span class="p">.</span><span class="nx">chain</span><span class="p">([])</span>
          <span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">baseDefinition</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">mixins</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">union</span><span class="p">(</span><span class="nx">options</span><span class="p">.</span><span class="nx">mixins</span><span class="p">)</span>
          <span class="p">.</span><span class="nx">compact</span><span class="p">().</span><span class="nx">uniq</span><span class="p">().</span><span class="nx">value</span><span class="p">()</span>
        <span class="nv">mixinDefaults = </span><span class="nx">baseDefinition</span><span class="p">.</span><span class="nx">constructor</span><span class="o">::</span><span class="nx">mixinOptions</span>
        <span class="nx">extendMixinOptions</span> <span class="nx">definition</span><span class="p">.</span><span class="nx">mixinOptions</span><span class="p">,</span> <span class="nx">mixinDefaults</span>

      <span class="k">if</span> <span class="nb">Boolean</span> <span class="nx">options</span><span class="p">.</span><span class="nx">singleton</span>
      <span class="k">then</span> <span class="nv">options.singleton = </span><span class="nb">Boolean</span> <span class="nx">options</span><span class="p">.</span><span class="nx">singleton</span>
      <span class="k">else</span> <span class="nv">options.singleton = </span><span class="nb">Boolean</span> <span class="nx">baseDefinition</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">singleton</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-22" id="section-22">&#182;</a>
</div>
<p>No class-level extend method? No problem. We'll borrow Backbone's</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">extend = </span><span class="nx">baseDefinition</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">extend</span> <span class="o">or</span> <span class="nx">Backbone</span><span class="p">.</span><span class="nx">Model</span><span class="p">.</span><span class="nx">extend</span>
      <span class="nv">extendedDefinition = </span><span class="nx">extend</span><span class="p">.</span><span class="nx">call</span> <span class="nx">baseDefinition</span><span class="p">.</span><span class="nx">constructor</span><span class="p">,</span> <span class="nx">definition</span>

      <span class="k">return</span> <span class="nx">@define</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">extendedDefinition</span><span class="p">,</span> <span class="nx">options</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="has%20definition">
  <h2>
    <a href="#has%20definition" name="has%20definition" class="pilcrow">&#182;</a>
    Has Definition
  </h2>
</div>


<p>Find out if the factory has a definition by name.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nv">hasDefinition: </span><span class="nf">(name) -&gt;</span>
      <span class="k">return</span> <span class="nx">@getDefinition</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="o">?</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get%20definition">
  <h2>
    <a href="#get%20definition" name="get%20definition" class="pilcrow">&#182;</a>
    Get Definition
  </h2>
</div>


<p>Finds a requested definition in the current or mirrored mirrors</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nv">getDefinition: </span><span class="nf">(name) -&gt;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">definition = </span><span class="nx">@definitions</span><span class="p">[</span><span class="nx">name</span><span class="p">])</span><span class="o">?</span>
        <span class="k">return</span> <span class="nv">definitionSpec = </span><span class="p">{</span><span class="nx">definition</span><span class="p">,</span> <span class="nv">factory: </span><span class="k">this</span><span class="p">}</span>
      <span class="k">for</span> <span class="nx">factory</span> <span class="k">in</span> <span class="nx">@mirrors</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">definitionSpec = </span><span class="nx">factory</span><span class="p">.</span><span class="nx">getDefinition</span> <span class="nx">name</span><span class="p">)</span><span class="o">?</span>
          <span class="k">return</span> <span class="nx">definitionSpec</span>

    <span class="nv">_getDefinitionSpec: </span><span class="nf">(name) -&gt;</span>
      <span class="k">throw</span> <span class="k">new</span> <span class="nx">ReferenceError</span> <span class="s">&quot;&quot;&quot;</span>
<span class="s">        Factory</span><span class="err">#</span><span class="s">_getDefinitionSpec Definition </span><span class="si">#{</span><span class="nx">name</span><span class="si">}</span><span class="s"> does not exist.</span>
<span class="s">      &quot;&quot;&quot;</span> <span class="k">unless</span> <span class="p">(</span><span class="nv">definitionSpec = </span><span class="nx">@getDefinition</span> <span class="nx">name</span><span class="p">)</span><span class="o">?</span>
      <span class="k">return</span> <span class="nx">definitionSpec</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="fetch%20definition">
  <h2>
    <a href="#fetch%20definition" name="fetch%20definition" class="pilcrow">&#182;</a>
    Fetch Definition
  </h2>
</div>


<p>Fetch a definition from the server and callback when done</p>

<p>WARNING! this will not work with jquery or other polymorphic
function API's. It expects functions to be constructors!
TODO: This should support CJS/Node</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nv">fetchDefinition: </span><span class="nf">(name) -&gt;</span>
      <span class="nx">require</span> <span class="p">[</span><span class="nx">name</span><span class="p">],</span> <span class="nf">(definition) =&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-26" id="section-26">&#182;</a>
</div>
<p>Just in case the module is not setup to use the factory
this will get ignored if the module defines itself in the
factory.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
        <span class="nx">@define</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">definition</span>
      <span class="k">return</span> <span class="nx">@whenDefined</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="when%20defined">
  <h2>
    <a href="#when%20defined" name="when%20defined" class="pilcrow">&#182;</a>
    When Defined
  </h2>
</div>


<p>Find out when a definition has been loaded into the factory
by name. This returns a jQuery promise object.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nv">whenDefined: </span><span class="nf">(name) -&gt;</span>
      <span class="k">return</span> <span class="nx">@promises</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">?=</span> <span class="nx">$</span><span class="p">.</span><span class="nx">Deferred</span><span class="p">()</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get%20constructor">
  <h2>
    <a href="#get%20constructor" name="get%20constructor" class="pilcrow">&#182;</a>
    Get Constructor
  </h2>
</div>


<p>This allows you to use the factory in contexts where a constructor
function is expected. The instances returned from this constructor will
support all the functionality of the factory including mixins, tags and
singleton. Optionally you can pass in the original flag to get the
original constructor method. Use this for instance of checks.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nv">getConstructor: </span><span class="nf">(name, original = false) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-29" id="section-29">&#182;</a>
</div>
<p>Attempt to resolve the defintion from this, or upstream mirrors.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="p">{</span><span class="nx">definition</span><span class="p">,</span> <span class="nx">factory</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@_getDefinitionSpec</span> <span class="nx">name</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-30" id="section-30">&#182;</a>
</div>
<p>If the original ctor was requested, return it immediately.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="k">return</span> <span class="nx">definition</span><span class="p">.</span><span class="nx">constructor</span> <span class="k">if</span> <span class="nx">original</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-31" id="section-31">&#182;</a>
</div>
<p>Else, create a ctor partial bount to the factory get method.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">ctor = </span><span class="o">=&gt;</span> <span class="nx">@getInstance</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">arguments</span><span class="p">...</span>
      <span class="nv">ctor.prototype = </span><span class="nx">definition</span><span class="p">.</span><span class="nx">constructor</span><span class="p">.</span><span class="nx">prototype</span>

      <span class="k">return</span> <span class="nx">ctor</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get">
  <h2>
    <a href="#get" name="get" class="pilcrow">&#182;</a>
    Get
  </h2>
</div>


<p>An alias for getInstance</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nv">get: </span><span class="nf">-&gt;</span> <span class="nx">@getInstance</span> <span class="nx">arguments</span><span class="p">...</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="get%20instance">
  <h2>
    <a href="#get%20instance" name="get%20instance" class="pilcrow">&#182;</a>
    Get Instance
  </h2>
</div>


<p>Call this with the name of the object type you want to get. You will
definitely get that kind of object back. This is a pretty big function
but it's just generally making decisions about the options you defined
earlier.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nv">getInstance: </span><span class="nf">(name, args...) -&gt;</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-34" id="section-34">&#182;</a>
</div>
<p>Check to see if an instance of this definition already exists in this
or any mirrored factories</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">instance = </span><span class="nx">@_getFirstInstanceFromMemory</span><span class="p">(</span><span class="nx">name</span><span class="p">)</span><span class="o">?</span><span class="p">.</span><span class="nx">instance</span>
      <span class="k">return</span> <span class="nx">instance</span> <span class="k">if</span> <span class="nx">instance</span> <span class="o">and</span> <span class="nx">instance</span><span class="p">.</span><span class="nx">__singleton</span><span class="o">?</span><span class="p">()</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-35" id="section-35">&#182;</a>
</div>
<p>Attempt to resolve the defintion from this, or upstream mirrors.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="p">{</span><span class="nx">definition</span><span class="p">,</span> <span class="nx">factory</span><span class="p">}</span> <span class="o">=</span> <span class="nx">@_getDefinitionSpec</span> <span class="nx">name</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-36" id="section-36">&#182;</a>
</div>
<p>Resolve all the options for this definition</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">mixins = </span><span class="nx">definition</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">mixins</span> <span class="o">or</span> <span class="p">[]</span>
      <span class="nv">singleton = </span><span class="nb">Boolean</span> <span class="nx">definition</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">singleton</span>
      <span class="nv">injections = </span><span class="nx">definition</span><span class="p">.</span><span class="nx">options</span><span class="p">.</span><span class="nx">injections</span> <span class="o">or</span> <span class="p">[]</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-37" id="section-37">&#182;</a>
</div>
<p>Get a reference to the constructor</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">Constructor = </span><span class="nx">definition</span><span class="p">.</span><span class="nx">constructor</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-38" id="section-38">&#182;</a>
</div>
<p>Enhance the constructor's prototype so that the factory interfaces
are available immediately upon construction.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">_enhanceObject</span> <span class="k">this</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">definition</span><span class="p">,</span> <span class="nx">Constructor</span><span class="p">.</span><span class="nx">prototype</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-39" id="section-39">&#182;</a>
</div>
<p>Create the instance</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">instance = </span><span class="k">new</span> <span class="nx">Constructor</span> <span class="nx">args</span><span class="p">...</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-40" id="section-40">&#182;</a>
</div>
<p>Enhance the instance, in case it's a bare object instead of a proper
Constructor.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">_enhanceObject</span> <span class="k">this</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">definition</span><span class="p">,</span> <span class="nx">instance</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-41" id="section-41">&#182;</a>
</div>
<p>Set the constructor of the instance to one that's factory wrapped</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nv">instance.constructor = </span><span class="nx">factory</span><span class="p">.</span><span class="nx">getConstructor</span> <span class="nx">name</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-42" id="section-42">&#182;</a>
</div>
<p>Then push the instance into the right cache.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@instances</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span> <span class="o">?=</span> <span class="p">[]</span>
      <span class="nx">@instances</span><span class="p">[</span><span class="nx">name</span><span class="p">].</span><span class="nx">push</span> <span class="nx">instance</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-43" id="section-43">&#182;</a>
</div>
<p>Ensure this definition has the appropriate caches on the factory.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@handleDefine</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">definition</span><span class="p">,</span> <span class="nv">ignore_promise: </span><span class="kc">true</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-44" id="section-44">&#182;</a>
</div>
<p>Compose mixins on the instance.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@handleMixins</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">mixins</span><span class="p">,</span> <span class="nx">args</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-45" id="section-45">&#182;</a>
</div>
<p>Compose injections on the instance.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@handleInjections</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">injections</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-46" id="section-46">&#182;</a>
</div>
<p>Trigger evets for tags on the instance.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@handleTags</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">definition</span><span class="p">.</span><span class="nx">tags</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-47" id="section-47">&#182;</a>
</div>
<p>If there's a constructed method, execute it with our ctor args.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">instance</span><span class="p">.</span><span class="nx">constructed</span><span class="o">?</span> <span class="nx">args</span><span class="p">...</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-48" id="section-48">&#182;</a>
</div>
<p>Notify any listeners that a new instance was created.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>
      <span class="nx">@trigger</span> <span class="s">&#39;create&#39;</span><span class="p">,</span> <span class="nx">name</span><span class="p">,</span> <span class="nx">instance</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span>

      <span class="k">return</span> <span class="nx">instance</span>

    <span class="nv">_getFirstInstanceFromMemory: </span><span class="nf">(name) -&gt;</span>
      <span class="k">if</span> <span class="p">(</span><span class="nv">instance = </span><span class="nx">@instances</span><span class="p">[</span><span class="nx">name</span><span class="p">]</span><span class="o">?</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">?</span>
        <span class="k">return</span> <span class="nv">instanceSpec = </span><span class="p">{</span><span class="nx">instance</span><span class="p">,</span> <span class="nv">factory: </span><span class="k">this</span><span class="p">}</span>
      <span class="k">for</span> <span class="nx">factory</span> <span class="k">in</span> <span class="nx">@mirrors</span>
        <span class="k">if</span> <span class="p">(</span><span class="nv">instanceSpec = </span><span class="nx">factory</span><span class="p">.</span><span class="nx">_getFirstInstanceFromMemory</span> <span class="nx">name</span><span class="p">)</span><span class="o">?</span>
          <span class="k">return</span> <span class="nx">instanceSpec</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="resolve%20instance">
  <h2>
    <a href="#resolve%20instance" name="resolve%20instance" class="pilcrow">&#182;</a>
    Resolve Instance
  </h2>
</div>


<p>Provide a method for resolving an instance via a callback or
by resolving an instance in the factory.</p>
        </td>
        <td class="code highlight"><div class="highlight"><pre>

    <span class="nv">resolveInstance: </span><span class="nf">(thing, args...) -&gt;</span>
      <span class="nv">thing = </span><span class="nx">thing</span><span class="p">.</span><span class="nx">call</span> <span class="k">this</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isFunction</span> <span class="nx">thing</span>
      <span class="nv">thing = </span><span class="nx">@getInstance</span> <span class="nx">thing</span><span class="p">,</span> <span class="nx">args</span><span class="p">...</span> <span class="k">if</span> <span class="nx">_</span><span class="p">.</span><span class="nx">isString</span> <span class="nx">thing</span>
      <span class="k">return</span> <span class="nx">thing</span>


</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap" id="mixins">
  <h2>
    <a href="#mixins" name="mixins" class="pilcrow">&#182;</a>
    Mixins
  </h2>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
    <span class="nx">Say</span> <span class="nx">something</span> <span class="nx">about</span> <span class="nx">mixins</span>

</pre></div>
        </td>
      </tr>
      <tr>
        <td class="docs">
<div class="pilwrap">
  <a class="pilcrow" href="#section-51" id="section-51">&#182;</a>
</div>

        </td>
        <td class="code highlight"><div class="highlight"><pre>
</pre></div>
        </td>
      </tr>
  </tbody>
</table>
  </div>
</body>
</html>
